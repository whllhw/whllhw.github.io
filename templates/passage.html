<html>
    <head>
        <meta charset="utf-8">
            <title>
                浏览文章
            </title>
        </meta>
        <link href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"/>
         <link rel="stylesheet" href="{{ url_for('static',filename='css/jquery.dataTables.min.css') }}" type="text/css" />
            <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js">
            </script>
            <script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js">
            </script>
             <script src="{{ url_for('static',filename='js/jquery.dataTables.min.js') }}"></script>
             <script src="{{ url_for('static',filename='js/sweetalert.min.js') }}"></script>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
				
                <!-- </div> -->
                <!-- <div class="col-md-10"> -->
                    <table class="table table-hover" id="datatable">
                        <thead>
                            <tr>
                                <th>编号</th>
                                <th>标题</th>
                                <!-- <th>作者</th> -->
                                <th>时间</th>
                                <th>内容</th>
                                <!-- <th>操作</th> -->
                            </tr>
                        </thead>
                        <tbody>
                            {% for passage in passages %}
                            <tr>
                                <td>{{ passage.id }}</td>
                                <td>{{ passage.title }}</td>
                                <!-- <td>{{ passage.author_id }}</td> -->
                                <td>{{ passage.date }}</td>
                                <td>{{ passage.context[:15] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                        	<button id="newPassage" type="button" class="btn btn-primary">新文章</button>
                        	<button id="edit" type="button" class="btn btn-info">编辑</button>
			        		<button id="delete" type="button" class="btn btn-danger">删除</button>
			        		<button id="deply" type="button" class="btn btn-primary">上传</button>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </body>
    <script>
$(function(){
    var table = $('#datatable').DataTable({
    "columns": [
        {"data": "id"},
        {"data": "title"},
        //{"data": "author"},
        {"data": "date"},
        {"data": "context"},],
        "order":[2,'desc']
	});
    $('#datatable tbody').on( 'click', 'tr', function () {
	    if ( $(this).hasClass('selected') ) {
	        $(this).removeClass('selected');
	    }
	    else {
	        table.$('tr.selected').removeClass('selected');
	        $(this).addClass('selected');
	    }
	});
    $('#edit').click(function(){
    	let data = table.row('.selected').data();
    	if(!data) {return;}
    	window.location.href = "{{ url_for('edit',_external=true) }}/" + data['id'];
    });
    $('#newPassage').click(function(){
    	window.location.href = "{{ url_for('edit',_external=true) }}";
    });
    $('#delete').click(function(){
    	let class_name = $(this).attr('class');
    	let data = table.row('.selected').data();
		swal({
			title: "确定删除该文章?",
			text: "无法恢复文章!" + data['title'],
			icon: "warning",
			buttons: true,
			dangerMode: true,
			})
		.then((willDelete) => {
		  if (willDelete) {
		  	$.get("{{ url_for('delete',_external=true) }}"+data['id'])
		  	.then(function(data){
		  		if(data.error === 0){
		  			swal("成功",data.msg,"success");
		  			table.row('.selected').remove().draw( false );
		  		}else{
		  			swal("错误",data.msg,"error");
		  		}
		  	});
		  }
		});
    });
    $('#deply').click(function(){
    	let data = table.row('.selected').data();
    	$.get("{{ url_for('sync',_external=true) }}" +data['id'])
    	.done(function(data){
    		if(data.error !== 0){
    			swal("失败",data.msg,'error');
    		}
    	}).fail(function(xhr){
    		console.log(xhr);
    	});
    	$.get("{{ url_for('deploy',_external=true) }}")
    	.done(function(data){
    		if(data.msg === 0){
    			swal("成功",data.msg,'success');
    		}else{
    			swal("失败",data.msg,'error');
    		}
    	}).fail(function(xhr){console.log(xhr);});
    });
});
    </script>
</html>